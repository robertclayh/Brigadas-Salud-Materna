name: Daily Data Pipeline

on:
  schedule:
    - cron: '0 2 * * *'   # daily at 02:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: data-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Fetch ADM2 shapefile from HDX
        run: python scripts/fetch_spatial_assets.py

      # Optional narrow checkout:
      # - name: Narrow checkout (optional)
      #   run: |
      #     git sparse-checkout init --cone
      #     git sparse-checkout set data out .github pipeline.py README.md requirements.txt

      - name: Verify ADM2 shapefile is present (not an LFS pointer)
        run: |
          set -euo pipefail
          SHPDIR="data/mex_admbnda_govmex_20210618_SHP"
          SHP="$SHPDIR/mex_admbnda_adm2_govmex_20210618.shp"

          for f in "$SHP" "$SHPDIR/mex_admbnda_adm2_govmex_20210618.dbf" "$SHPDIR/mex_admbnda_adm2_govmex_20210618.shx"; do
            if [ ! -f "$f" ]; then
              echo "Missing required file: $f"
              exit 1
            fi
            if head -n1 "$f" | grep -q "version https://git-lfs.github.com/spec/v1"; then
              echo "ERROR: $f is a Git LFS pointer (not the real file)."
              echo "--- Git LFS last logs (for diagnosis) ---"
              git lfs logs last || true
              exit 1
            fi
            if [ ! -s "$f" ]; then
              echo "ERROR: $f exists but is zero bytes."
              exit 1
            fi
          done
          echo "ADM2 shapefile assets look good."

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gdal-bin \
            libgdal-dev \
            libgeos-dev \
            libproj-dev \
            libspatialindex-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Derive flags for creds step
        id: flags
        env:
          ENABLE_SHEETS: ${{ secrets.ENABLE_SHEETS }}
          GOOGLE_CREDS_JSON: ${{ secrets.GOOGLE_CREDS_JSON }}
        run: |
          es="${ENABLE_SHEETS:-false}"
          if [ "$es" = "true" ] && [ -n "$GOOGLE_CREDS_JSON" ]; then
            echo "create_creds=true" >> "$GITHUB_OUTPUT"
          else
            echo "create_creds=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Google credentials file (if enabled)
        if: ${{ steps.flags.outputs.create_creds == 'true' }}
        env:
          GOOGLE_CREDS_CONTENT: ${{ secrets.GOOGLE_CREDS_JSON }}
        run: |
          mkdir -p "$HOME/.config/gcloud"
          if echo "$GOOGLE_CREDS_CONTENT" | grep -q '"type": *"service_account"'; then
            printf '%s' "$GOOGLE_CREDS_CONTENT" > "$HOME/.config/gcloud/credentials.json"
          else
            echo "$GOOGLE_CREDS_CONTENT" | base64 -d > "$HOME/.config/gcloud/credentials.json"
          fi

      - name: Create .env file
        env:
          ACLED_USER: ${{ secrets.ACLED_USER }}
          ACLED_PASS: ${{ secrets.ACLED_PASS }}
          ENABLE_SHEETS: ${{ secrets.ENABLE_SHEETS || 'false' }}
          SHEET_NAME: ${{ secrets.SHEET_NAME || 'mx_brigadas_dashboard' }}
          HISTORY_SHEET_NAME: ${{ secrets.HISTORY_SHEET_NAME || 'mx_brigadas_dashboard_history' }}
          LIGHTWEIGHT_HISTORY_SHEET_NAME: ${{ secrets.LIGHTWEIGHT_HISTORY_SHEET_NAME || 'mx_brigadas_dashboard_lightweight_history' }}
          COMBINED_SHEET_NAME: ${{ secrets.COMBINED_SHEET_NAME || 'mx_brigadas_dashboard_combined' }}
        run: |
          GOOGLE_CREDS_PATH=""
          if [ "$ENABLE_SHEETS" = "true" ] && [ -f "$HOME/.config/gcloud/credentials.json" ]; then
            GOOGLE_CREDS_PATH="$HOME/.config/gcloud/credentials.json"
          fi
          {
            printf 'ACLED_USER=%s\n' "$ACLED_USER"
            printf 'ACLED_PASS=%s\n' "$ACLED_PASS"
            printf 'SSL_VERIFY=true\n'
            printf 'ACLED_REFRESH=true\n'
            printf 'CAST_REFRESH=true\n'
            printf 'FORCE_REBUILD_POP=false\n'
            printf 'ENABLE_SHEETS=%s\n' "$ENABLE_SHEETS"
            printf 'SHEET_NAME=%s\n' "$SHEET_NAME"
            printf 'HISTORY_SHEET_NAME=%s\n' "$HISTORY_SHEET_NAME"
            printf 'LIGHTWEIGHT_HISTORY_SHEET_NAME=%s\n' "$LIGHTWEIGHT_HISTORY_SHEET_NAME"
            printf 'COMBINED_SHEET_NAME=%s\n' "$COMBINED_SHEET_NAME"
            printf 'GOOGLE_CREDS_JSON=%s\n' "$GOOGLE_CREDS_PATH"
          } > .env

      - name: Run pipeline
        run: python pipeline.py

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git config --local pull.rebase true

      - name: Stage and commit data artifacts
        run: |
          if [ ! -d "out" ]; then
            echo "ERROR: out/ directory does not exist - pipeline may have failed"
            exit 1
          fi
          git add out/
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Update data pipeline outputs - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"

      - name: Rebase on latest main and push (with retries)
        run: |
          set -e
          git fetch origin main
          git rebase origin/main || {
            echo "Rebase failed; resolving by favoring generated artifacts in out/."
            git checkout --ours -- out || true
            git add out || true
            git rebase --continue || true
          }

          for i in 1 2 3; do
            if git push origin HEAD:main; then
              echo "Push succeeded."
              exit 0
            fi
            echo "Push attempt $i failed; rebasing onto latest main and retrying..."
            git fetch origin main
            git rebase origin/main || true
            sleep $((i*2))
          done
          echo "ERROR: Failed to push after multiple attempts."
          exit 1
